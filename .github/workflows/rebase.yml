name: ðŸ§¬ Automatic Rebase
on:
  issue_comment:
    if: >-
      github.event.issue.pull_request != '' &&
      (
        contains(github.event.comment.body, '@gitbot rebase') ||
        contains(github.event.comment.body, '@gitbot squash')
      )
    types: [created]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.id }}

jobs:
  catch-comment:
    name: ðŸ‘€ Catch comment
    runs-on: ubuntu-20.04
    steps:
      - name: ðŸ‘€ Reaction to comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes

  rebase-squash:
    outputs:
      rebase-squash: ${{ steps.rebase-squash.outputs.output }}
    name: ðŸ§¬ Rebase or Squash
    if: >-
      (
        github.event.comment.user.id == github.event.repository.owner.id ||
        github.event.comment.author_association == 'MEMBER' ||
        contains(github.event.issue.assignees.*.id, github.event.comment.user.id) ||
        github.event.comment.user.id == github.event.issue.user.id
      )
    runs-on: ubuntu-20.04
    steps:
      - uses: hmarr/debug-action@v2

      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ§¬ Rebase or Squash
        id: rebase-squash
        uses: cirrus-actions/rebase@1.7
        with:
          autosquash: ${{ contains(github.event.comment.body, '@gitbot squash') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ‘ Reaction to comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "+1"

      - name: ðŸ’¬ Reply comment
        if: >-
          contains(
            join(steps.rebase-squash.outputs.*, '\n'),
            'Everything up-to-date'
          )
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### Everything up-to-date ðŸŽ‰
            @${{ github.event.comment.user.login }} Everything up-to-date.
      - run: echo ${{join(steps.rebase-squash.outputs.*, '\n')}}

  permission-denied:
    needs: [rebase-squash]
    name: â›” Permission denied
    if: |
      always() &&
      needs.rebase-squash.result == 'skipped'
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ’¬ Reply comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### Permission denied â›”

            @${{ github.event.comment.user.login }} this functionality is not available to you.
            To use this functionality you must meet at least one of the following requirements:

            - [ ] Be the owner  of the repository
            - [ ] Be a   member of the organization
            - [ ] Be on the assignees list
            - [ ] Be the author of the pull request

      - name: ðŸ‘Ž Reaction to comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "-1"
