name: ğŸ§¬ Automatic Rebase
on:
  issue_comment:
    types: [created]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.id }}

jobs:
  catch-comment:
    name: ğŸ‘€ Catch comment
    if: >-
      github.event.issue.pull_request != '' &&
      (
        contains(github.event.comment.body, '@gitbot rebase') ||
        contains(github.event.comment.body, '@gitbot squash')
      )
    runs-on: ubuntu-20.04
    steps:
      - name: ğŸ‘€ Reaction to comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: eyes
      - name: ğŸ›‚ Check permissions
        id: check-permissions
        run: >-
          echo "::set-output name=permissions::${{(
            github.event.comment.user.id == github.event.repository.owner.id ||
            github.event.comment.author_association == 'MEMBER' ||
            contains(github.event.issue.assignees.*.id, github.event.comment.user.id) ||
            github.event.comment.user.id == github.event.issue.user.id
          )}}"
      - uses: hmarr/debug-action@v2

  rebase-squash:
    needs: [catch-comment]
    name: ğŸ§¬ Rebase or Squash
    if: needs.catch-comment.outputs.permissions == 'true'
    runs-on: ubuntu-20.04
    outputs:
      rebase-squash: ${{ steps.rebase-squash.outputs.output }}
    steps:
      - name: â¤µï¸ Check out code from GitHub
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ§¬ Rebase or Squash
        id: rebase-squash
        uses: cirrus-actions/rebase@1.7
        with:
          autosquash: ${{ contains(github.event.comment.body, '@gitbot squash') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‘ Reaction to comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "+1"
          edit-mode: replace

  permission-denied:
    needs: [catch-comment]
    name: â›” Permission denied
    if: needs.catch-comment.outputs.permissions == 'false'
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ’¬ Reply comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### Permission denied â›”

            @${{ github.event.comment.user.login }} this functionality is not available to you.
            To use this functionality you must meet at least one of the following requirements:

            - [ ] Be the owner  of the repository
            - [ ] Be a   member of the organization
            - [ ] Be on the assignees list
            - [ ] Be the author of the pull request

      - name: ğŸ‘ Reaction to comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: "-1"
          edit-mode: replace
